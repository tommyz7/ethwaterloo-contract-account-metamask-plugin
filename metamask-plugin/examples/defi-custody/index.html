<!doctype html>

<html>

</head>
<title>defi-custody</title>
<link rel="stylesheet" href="bootstrap.min.css">
<link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="container mainContainer">
  <div class="topTitle">Invokeable Contract Addresses in MetaMask (Plugin) </div>
    <div class="secondaryInstructions">Make sure the plugin bundle is currently hosted on localhost:8089 for this to work.</div>
  
    <div class="row rowItem"> 
      <div class="col-md-5">
        <button class="connectAndInstall btn-secondary">Connect and Install</button>
      </div>
      <div class="col-md-4">
  
      </div>
    </div>

  
    <div class="row rowItem"> 
      <div class="col-md-5">
        MetaMask Contract Account
      </div>
      <div class="col-md-3">
        <button class="createAccount btn-primary">Create</button>
      </div>
    </div>

      <div class="row rowItem"> 
        <div class="col-md-5">
            <input class="recoveryAddrInput" placeholder="Enter Recover 0x or ENS address" size="40" />
        </div>
        <div class="col-md-3">
            <button class="recoveryAddr btn-primary">Set Recovery Address</button>
        </div>
      </div>
   


    <div class="row rowItem"> 
        <div class="col-md-5">
            <div id="countdown">--</div>
        </div>
        <div class="col-md-4">
            <button class="resetCountdown btn-primary">Sign Tx to Reset Countdown</button>
        </div>
      </div>

    </div>
  </div>
</div>


</body>

<script>

const origin = 'http://localhost:8089/package.json'
const pluginOrigin = `wallet_plugin_${origin}`

const connectAndInstallButton = document.querySelector('button.connectAndInstall')
const resetCountdownButton = document.querySelector('button.resetCountdown')
//const connectButton = document.querySelector('button.connect')
//const addButton = document.querySelector('button.add')
//const tipButton = document.querySelector('button.tip')
//const createAccountButton = document.querySelector('button.createAccount')

//defi-custody poc
const createAccountButton = document.querySelector('button.createAccount')
createAccountButton.addEventListener('click', add)
resetCountdownButton.addEventListener('click', reset)


connectAndInstallButton.addEventListener('click', connectAndInstall)
//connectButton.addEventListener('click', add)
//addButton.addEventListener('click', add)
//tipButton.addEventListener('click', tip)
// depositButton.addEventListener('click', deposit)

const recoveryAddrButton = document.querySelector('button.recoveryAddr')
recoveryAddrButton.addEventListener('click', recovery)




function startTimer(){ 
  var countDownDate = new Date("Jan 5, 2021 15:37:25").getTime();

  // Update the count down every 1 second
  var x = setInterval(function() {

    // Get today's date and time
    var now = new Date().getTime();

    // Find the distance between now and the count down date
    var distance = countDownDate - now;

    // Time calculations for days, hours, minutes and seconds
    var days = Math.floor(distance / (1000 * 60 * 60 * 24));
    var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    var seconds = Math.floor((distance % (1000 * 60)) / 1000);

    // Display the result in the element with id="demo"
    document.getElementById("countdown").innerHTML = days + "d " + hours + "h "
    + minutes + "m " + seconds + "s ";

    // If the count down is finished, write some text
    if (distance < 0) {
      clearInterval(x);
      document.getElementById("countdown").innerHTML = "EXPIRED";
    }
  }, 1000);
}


async function createAccount () {
  console.log('createAccount()');
}

async function connectAndInstall () {
  await ethereum.send({
    method: 'wallet_requestPermissions',
    params: [{
      'eth_accounts': {},
      [pluginOrigin]: {},
    }]
  })
  
}


async function reset() {
  console.log('reset');
}


async function connect () {
  await ethereum.send({
    method: 'wallet_requestPermissions',
    params: [{
      'eth_accounts': {},
    }]
  })
}

async function add () {
  
  const result = await ethereum.send({
    method: pluginOrigin,
    params: [{
      method: 'addAccount',
      params: [],
    }]
  })

  if (result) {
    alert(`Apparent success: ${JSON.stringify(result)}!`)
  }
  startTimer();
}


async function recovery() {
  const input = document.querySelector('input.recoveryAddrInput').value
  console.log('got recovery addr:', input);

  if (!input){
    alert('please provide an address in requested format');
    return
  }

  var timeDelta = 5000

  const result = await ethereum.send({
    method: pluginOrigin,
    params: [{
      method: 'setRecoveryAddress',
      params: [ input, timeDelta ],
    }]
  }) 
  
}


async function deposit() {
  const to = document.querySelector('input.addressTo').value
  const value = document.querySelector('input.value').value

  const result = await ethereum.send({
    method: pluginOrigin,
    params: [{
      method: 'deposit',
      params: [ input ],
    }]
  }) 
}

async function tip () {
  const response = await ethereum.send({
    method: 'eth_accounts',
  })
  const account = response.result[0]
  console.log(`Account ${account} chosen from ${JSON.stringify(response)}`)
  const to = document.querySelector('input.address').value

  try {
    const response2 = await ethereum.send({
      method: 'eth_sendTransaction',
      params: [{
        from: account,
        value: '0x10000000000000',
        to: to,
      }]
    })
    console.log('response2 DAPP', response2);
    if (response2) {
      alert(`Site received tip result: ${response2.result}!`)
    }
  } catch (err) {
    alert(`Problem tipping: ${JSON.stringify(err)}`)
  }
}


</script>

</html>
